# Dicee Project - Windsurf/Cascade Rules

## Agent Identity
You are Cascade, the AI assistant in Windsurf IDE, working on Dicee - a dice probability engine and multiplayer game platform running on Cloudflare (Pages + Durable Objects).

**Production**: https://dicee.games

## Critical Rules

### Three Strikes Rule (MANDATORY)
If you fail at the same operation **3 times**, **STOP and ask the human**.

### Read Before Edit
NEVER modify a file you haven't read in this session.

### Verify After Change
```bash
pnpm check && pnpm biome:check && pnpm web:vitest
```

## MCP Tools

> **Reference**: `docs/PROJECT-MCP-CONFIG.md` - Full MCP Tool Decision Matrix

### Tool Priority
1. **Library docs** → `context7` (auto-invoke for SvelteKit, Zod, etc.)
2. **Cloudflare docs** → `cloudflare-docs`
3. **Worker logs** → `cloudflare-observability`
4. **Import validation** → `akg_check_import` (ALWAYS before adding imports)
5. **Project memory** → `memory`

### Key Tools
| Task | MCP Tool |
|------|----------|
| SvelteKit/Svelte 5 API | `context7.get-library-docs` |
| Cloudflare questions | `cloudflare-docs` |
| Debugging dicee | `cloudflare-observability` |
| "Can I import X here?" | `akg.akg_check_import` |
| Architecture rules | `akg.akg_layer_rules` |

## Naming Conventions

```
Components:   PascalCase.svelte
Callbacks:    onVerb (onRoll, onScore)
DOM events:   lowercase (onclick)
Handlers:     handleVerb
Booleans:     is/has/can prefix
CSS classes:  kebab-case
Stores:       *.svelte.ts
```

## Layer Architecture (AKG Enforced)

**Use `akg_check_import` before adding imports!**

```
routes      → components, stores, services, types, wasm
components  → components, types (NOT stores, services)
stores      → services, types (NOT components, routes)
services    → types, wasm (NOT components, routes, stores)
```

## Svelte 5 Patterns

```svelte
<script lang="ts">
  // State
  let count = $state(0);
  let doubled = $derived(count * 2);

  // Props
  interface Props {
    value: number;
    onUpdate: (n: number) => void;  // onVerb pattern
  }
  let { value, onUpdate }: Props = $props();

  // Effects
  $effect(() => { console.log(count); });
</script>
```

## Quality Gate

```bash
./scripts/quality-gate.sh
```

Or individual checks:
```bash
pnpm check          # TypeScript + Svelte
pnpm biome:check    # Lint
pnpm web:vitest     # Tests
pnpm akg:check      # Architecture invariants
```

## Testing

Co-locate tests with source:
```
src/lib/components/ui/
├── Avatar.svelte
└── __tests__/
    └── Avatar.test.ts
```

Run tests:
```bash
pnpm web:vitest -- Avatar
```

## Slash Commands

| Command | Purpose |
|---------|---------|
| `/status` | Current phase/tasks |
| `/akg` | Architecture queries |
| `/build-component` | Guided component creation |

## Handoff

When handing off to Claude Code:
1. Update `.claude/state/session-handoff.md`
2. Note what's complete and what's next
3. Include any blockers

## References

- Guardrails: `.claude/AGENT-GUARDRAILS.md`
- Conventions: `.claude/CONVENTIONS.md`
- MCP Decision Matrix: `docs/PROJECT-MCP-CONFIG.md`
- AKG docs: `docs/architecture/akg/`
