/**
 * Dicee Global Styles
 * Base styles and resets for Neo-Brutalist design
 */

@import "./tokens.css";
@import "./cartridge-tokens.css";

/* ==========================================================================
 * iOS Viewport & Mobile Handling
 * 
 * Addresses iOS Safari viewport issues:
 * - Dynamic viewport height (dvh/svh) with fallback for older browsers
 * - Safe area insets for notched devices
 * - Pinch-zoom corruption detection and prevention
 * - Mobile keyboard handling
 * 
 * The iOS viewport issue stems from Safari's dynamic UI - the address bar
 * collapses on scroll, changing the actual viewport height. dvh/svh units
 * handle this, but older browsers need a JavaScript fallback.
 * 
 * @see docs/references/keyboard-layout-research.md
 * ========================================================================== */

:root {
	/* ===== Dynamic Viewport Units ===== */
	/* 
	 * Viewport height variables with fallback chain:
	 * 1. dvh (dynamic) - changes as browser chrome appears/disappears
	 * 2. svh (small) - viewport with all browser UI visible
	 * 3. lvh (large) - viewport with minimal browser UI
	 * 4. vh - legacy fallback
	 */
	--viewport-height-dynamic: 100dvh;
	--viewport-height-small: 100svh;
	--viewport-height-large: 100lvh;

	/* JavaScript-calculated fallback (set by viewport.ts) */
	--vh-fallback: 1vh;
	--viewport-height: 100vh;

	/* ===== Safe Area Insets ===== */
	/* For notch and home indicator on iOS devices */
	--safe-top: env(safe-area-inset-top, 0px);
	--safe-bottom: env(safe-area-inset-bottom, 0px);
	--safe-left: env(safe-area-inset-left, 0px);
	--safe-right: env(safe-area-inset-right, 0px);

	/* ===== Keyboard Handling ===== */
	/* Updated by keyboard.ts via VisualViewport API */
	--keyboard-height: 0px;
}

/* Fallback for browsers without dvh support */
@supports not (height: 100dvh) {
	:root {
		--viewport-height-dynamic: calc(var(--vh-fallback) * 100);
	}
}

/* Class added by viewport.ts when dvh is not supported */
.no-dvh {
	--viewport-height-dynamic: var(--viewport-height);
}

/* ==========================================================================
 * Viewport Utility Classes
 * ========================================================================== */

/* Full-height container using svh (stable, accounts for browser chrome) */
.h-screen-safe {
	height: 100vh;
	/* biome-ignore lint/suspicious/noDuplicateProperties: Intentional fallback - svh not supported in older browsers */
	height: 100svh;
}

/* Full-height container using dvh (dynamic, responds to browser chrome) */
.h-screen-dynamic {
	height: 100vh;
	/* biome-ignore lint/suspicious/noDuplicateProperties: Intentional fallback */
	height: 100dvh;
}

/* Fallback for no-dvh browsers */
.no-dvh .h-screen-dynamic {
	height: var(--viewport-height);
}

/* Keyboard-aware full-height container */
.h-screen-keyboard {
	height: 100vh;
	/* biome-ignore lint/suspicious/noDuplicateProperties: Intentional fallback */
	height: calc(100svh - var(--keyboard-height, 0px));
}

/* Keyboard-aware bottom padding (VirtualKeyboard API + JS fallback) */
.keyboard-aware-bottom {
	padding-bottom: env(keyboard-inset-height, var(--keyboard-height, 0px));
}

/* Safe area insets for notched devices */
.safe-area-bottom {
	padding-bottom: var(--safe-bottom);
}

.safe-area-top {
	padding-top: var(--safe-top);
}

.safe-area-all {
	padding-top: var(--safe-top);
	padding-bottom: var(--safe-bottom);
	padding-left: var(--safe-left);
	padding-right: var(--safe-right);
}

/* ==========================================================================
 * App Shell Layout (iOS-safe)
 * 
 * Use for full-screen app layouts that need to handle iOS viewport issues.
 * Combines dynamic viewport height with safe area handling.
 * ========================================================================== */

.app-shell {
	display: flex;
	flex-direction: column;
	height: 100dvh;
	/* biome-ignore lint/suspicious/noDuplicateProperties: Intentional fallback for no-dvh browsers */
	height: var(--viewport-height-dynamic);
	width: 100%;
	overflow: hidden;
}

.app-shell__header {
	flex-shrink: 0;
	padding-top: var(--safe-top);
}

.app-shell__content {
	flex: 1 1 auto;
	overflow-y: auto;
	-webkit-overflow-scrolling: touch;
	overscroll-behavior-y: contain;
	min-height: 0; /* Critical for flex scroll containers */
}

.app-shell__footer {
	flex-shrink: 0;
	padding-bottom: var(--safe-bottom);
}

/* ==========================================================================
 * Touch Action Control (Pinch-Zoom Prevention)
 * 
 * Apply to game containers to prevent accidental pinch-zoom that
 * can corrupt the iOS viewport.
 * ========================================================================== */

/* Prevent all touch actions except tap and horizontal scroll */
.touch-action-pan-x {
	touch-action: pan-x;
}

/* Prevent zoom gestures but allow pan */
.touch-action-manipulation {
	touch-action: manipulation;
}

/* Prevent all gestures (use sparingly) */
.touch-action-none {
	touch-action: none;
}

/* ==========================================================================
 * Viewport Corruption Recovery
 * 
 * Applied by viewport.ts when pinch-zoom corruption is detected.
 * Forces a repaint to help recover from viewport issues.
 * ========================================================================== */

html.viewport-corrupted body {
	/* Force reflow */
	transform: translateZ(0);
}

html.viewport-repair body {
	/* Temporary state during repair */
	opacity: 0.999;
}

/* ==========================================================================
 * Keyboard-Aware Layout Utilities
 * 
 * These utility classes provide consistent keyboard-aware behavior across
 * components. Use these instead of duplicating :global(html.keyboard-open)
 * rules in individual components.
 * 
 * Usage:
 *   <div class="hide-on-keyboard">Hidden when keyboard open</div>
 *   <div class="shrink-on-keyboard">Shrinks to 120px when keyboard open</div>
 *   <div class="keyboard-aware-max-height">Respects keyboard height</div>
 * 
 * NOTE: These use html.keyboard-open selector for high specificity without !important.
 * ========================================================================== */

/* Hide element when keyboard is open (mobile only) */
@media (max-width: 768px) {
	html.keyboard-open .hide-on-keyboard {
		display: none;
	}

	/* Reduce element height when keyboard is open */
	html.keyboard-open .shrink-on-keyboard {
		max-height: 120px;
		overflow: hidden;
	}

	/* Limit container to available space above keyboard */
	html.keyboard-open .keyboard-aware-max-height {
		max-height: calc(100svh - var(--keyboard-height, 0px));
		overflow: hidden;
	}

	/* Align content to top when keyboard is open (useful for centered containers) */
	html.keyboard-open .keyboard-align-top {
		align-items: flex-start;
	}
}

/* ==========================================================================
 * Reset & Base
 * ========================================================================== */

*,
*::before,
*::after {
	box-sizing: border-box;
	margin: 0;
	padding: 0;
}

html {
	font-size: 16px;
	-webkit-font-smoothing: antialiased;
	-moz-osx-font-smoothing: grayscale;
	text-rendering: optimizeLegibility;
}

body {
	font-family: var(--font-mono);
	font-size: var(--text-body);
	font-weight: var(--weight-normal);
	line-height: 1.5;
	color: var(--color-text);
	background-color: var(--color-background);
}

/* ==========================================================================
 * Typography
 * ========================================================================== */

h1,
h2,
h3,
h4,
h5,
h6 {
	font-weight: var(--weight-bold);
	line-height: 1.2;
	letter-spacing: var(--tracking-wide);
}

h1 {
	font-size: var(--text-h1);
	font-weight: var(--weight-black);
	letter-spacing: var(--tracking-widest);
	text-transform: uppercase;
}

h2 {
	font-size: var(--text-h2);
	font-weight: var(--weight-bold);
	letter-spacing: var(--tracking-wider);
	text-transform: uppercase;
}

h3 {
	font-size: var(--text-h3);
	font-weight: var(--weight-semibold);
}

p {
	margin-bottom: var(--space-2);
}

/* Monospace for scores and statistics */
.mono {
	font-family: var(--font-mono);
	font-variant-numeric: tabular-nums;
	font-feature-settings: "tnum" 1;
}

/* ==========================================================================
 * Interactive Elements
 * ========================================================================== */

button {
	font-family: inherit;
	font-size: inherit;
	cursor: pointer;
	border: none;
	background: none;
}

button:disabled {
	cursor: not-allowed;
	opacity: 0.5;
}

/* Neo-Brutalist Button */
.btn {
	display: inline-flex;
	align-items: center;
	justify-content: center;
	gap: var(--space-1);
	padding: var(--space-2) var(--space-3);
	font-weight: var(--weight-bold);
	text-transform: uppercase;
	letter-spacing: var(--tracking-wide);
	background: var(--color-accent);
	border: var(--border-thick);
	transition:
		transform var(--transition-fast),
		background var(--transition-fast);
}

.btn:hover:not(:disabled) {
	background: var(--color-accent-dark);
	transform: translateY(-2px);
}

.btn:active:not(:disabled) {
	transform: translateY(0);
}

.btn:disabled {
	background: var(--color-disabled);
}

/* Secondary Button */
.btn-secondary {
	background: var(--color-surface);
}

.btn-secondary:hover:not(:disabled) {
	background: var(--color-background);
}

/* Ghost Button */
.btn-ghost {
	background: transparent;
	border: var(--border-thin);
}

.btn-ghost:hover:not(:disabled) {
	background: var(--color-accent-light);
}

/* ==========================================================================
 * Cards & Containers
 * ========================================================================== */

.card {
	background: var(--color-surface);
	border: var(--border-medium);
	padding: var(--space-3);
}

.card-header {
	padding-bottom: var(--space-2);
	margin-bottom: var(--space-2);
	border-bottom: var(--border-thin);
	font-weight: var(--weight-bold);
	text-transform: uppercase;
	letter-spacing: var(--tracking-wide);
}

/* ==========================================================================
 * Focus States (Accessibility)
 * ========================================================================== */

*:focus-visible {
	outline: 3px solid var(--color-accent);
	outline-offset: 2px;
}

/* ==========================================================================
 * Screen Reader Only
 * ========================================================================== */

.sr-only {
	position: absolute;
	width: 1px;
	height: 1px;
	padding: 0;
	margin: -1px;
	overflow: hidden;
	clip: rect(0, 0, 0, 0);
	white-space: nowrap;
	border: 0;
}

/* ==========================================================================
 * Utility Classes
 * ========================================================================== */

/* Text alignment */
.text-left {
	text-align: left;
}
.text-center {
	text-align: center;
}
.text-right {
	text-align: right;
}

/* Font variants */
.uppercase {
	text-transform: uppercase;
}
.capitalize {
	text-transform: capitalize;
}

/* Display */
.flex {
	display: flex;
}
.flex-col {
	flex-direction: column;
}
.items-center {
	align-items: center;
}
.justify-center {
	justify-content: center;
}
.justify-between {
	justify-content: space-between;
}
.gap-1 {
	gap: var(--space-1);
}
.gap-2 {
	gap: var(--space-2);
}
.gap-3 {
	gap: var(--space-3);
}

/* Spacing */
.mt-1 {
	margin-top: var(--space-1);
}
.mt-2 {
	margin-top: var(--space-2);
}
.mt-3 {
	margin-top: var(--space-3);
}
.mb-1 {
	margin-bottom: var(--space-1);
}
.mb-2 {
	margin-bottom: var(--space-2);
}
.mb-3 {
	margin-bottom: var(--space-3);
}
