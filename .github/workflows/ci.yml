name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  rust:
    name: Rust Tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: packages/engine
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy, rustfmt

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            packages/engine/target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('packages/engine/Cargo.lock') }}

      - name: Check formatting
        run: cargo fmt --check

      - name: Clippy
        run: cargo clippy -- -D warnings

      - name: Run unit tests
        run: cargo test --lib

      - name: Run known position tests
        run: cargo test --test known_positions

      - name: Run property-based tests (ADR-005)
        run: cargo test --test property_tests

      - name: Run doc tests
        run: cargo test --doc

  wasm:
    name: WASM Build
    runs-on: ubuntu-latest
    needs: rust
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown

      - name: Install wasm-pack
        run: cargo install wasm-pack

      - name: Build WASM
        working-directory: packages/engine
        run: wasm-pack build --target web --out-dir ../web/src/lib/wasm

      - name: Check WASM size (150KB limit)
        run: |
          SIZE=$(wc -c < packages/web/src/lib/wasm/dicee_engine_bg.wasm)
          echo "WASM size: ${SIZE} bytes"
          if [ $SIZE -gt 153600 ]; then
            echo "::error::WASM binary too large: ${SIZE} bytes (limit: 150KB = 153600 bytes)"
            exit 1
          fi
          echo "âœ… WASM size within limit"

      - name: Upload WASM artifact
        uses: actions/upload-artifact@v4
        with:
          name: wasm-pkg
          path: packages/web/src/lib/wasm/
          retention-days: 1

  web:
    name: Web Build & Test
    runs-on: ubuntu-latest
    needs: wasm
    env:
      # Public Supabase config (required for svelte-check to pass)
      # These are public values - anon key is safe to expose (it's in browser anyway)
      PUBLIC_SUPABASE_URL: https://duhsbuyxyppgbkwbbtqg.supabase.co
      PUBLIC_SUPABASE_ANON_KEY: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR1aHNidXl4eXBwZ2Jrd2JidHFnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzI4NjQ0OTAsImV4cCI6MjA0ODQ0MDQ5MH0.placeholder
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 24
          cache: pnpm

      - name: Download WASM artifact
        uses: actions/download-artifact@v4
        with:
          name: wasm-pkg
          path: packages/web/src/lib/wasm/

      - name: Install dependencies
        run: pnpm install

      - name: Build shared package
        run: pnpm --filter @dicee/shared build

      - name: Biome check
        run: pnpm --filter @dicee/web biome:check

      - name: Type check
        run: pnpm --filter @dicee/web check

      - name: Run tests (legacy API mode)
        run: pnpm --filter @dicee/web test -- run

      - name: Run tests (new engine mode)
        env:
          VITE_ENABLE_NEW_ENGINE: 'true'
        run: pnpm --filter @dicee/web test -- run

      - name: Build
        run: pnpm --filter @dicee/web build

  akg:
    name: Architecture Checks
    runs-on: ubuntu-latest
    needs: web
    permissions:
      contents: read
      security-events: write
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 24
          cache: pnpm

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: pnpm install

      - name: Build shared package
        run: pnpm --filter @dicee/shared build

      - name: Discover architecture graph
        run: pnpm akg:discover

      - name: Verify diagram staleness
        run: |
          pnpm akg:mermaid --check || {
            echo "::error::AKG diagrams are stale. Run 'pnpm akg:mermaid' locally and commit."
            exit 1
          }

      - name: Run architecture checks
        id: akg-check
        run: |
          # Run directly with bun to avoid pnpm output prefix in SARIF
          bun run packages/web/src/tools/akg/cli/check.ts --sarif > akg-results.sarif
          echo "exit_code=$?" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Upload SARIF to Code Scanning
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: akg-results.sarif
          category: architecture

      - name: Check for errors
        if: steps.akg-check.outputs.exit_code == '1'
        run: |
          echo "::error::AKG found architectural violations"
          pnpm akg:check
          exit 1

  cloudflare-do:
    name: Cloudflare DO Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 24
          cache: pnpm

      - name: Install dependencies
        run: pnpm install

      - name: Build shared package
        run: pnpm --filter @dicee/shared build

      - name: Type check
        run: pnpm --filter @dicee/cloudflare-do typecheck

      - name: Run tests
        run: pnpm --filter @dicee/cloudflare-do test -- run

  deploy-worker:
    name: Deploy Durable Objects Worker
    runs-on: ubuntu-latest
    needs: [cloudflare-do, akg]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    permissions:
      contents: read
      deployments: write
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 24
          cache: pnpm

      - name: Install dependencies
        run: pnpm install

      - name: Build shared package
        run: pnpm --filter @dicee/shared build

      - name: Deploy Worker to Cloudflare
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: packages/cloudflare-do
          command: deploy --env production
          secrets: |
            SUPABASE_URL
            SUPABASE_ANON_KEY
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}

  deploy-pages:
    name: Deploy to Cloudflare Pages
    runs-on: ubuntu-latest
    needs: [web, akg, deploy-worker]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    permissions:
      contents: read
      deployments: write
    env:
      PUBLIC_SUPABASE_URL: https://duhsbuyxyppgbkwbbtqg.supabase.co
      PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.PUBLIC_SUPABASE_ANON_KEY }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 24
          cache: pnpm

      - name: Download WASM artifact
        uses: actions/download-artifact@v4
        with:
          name: wasm-pkg
          path: packages/web/src/lib/wasm/

      - name: Install dependencies
        run: pnpm install

      - name: Build shared package
        run: pnpm --filter @dicee/shared build

      - name: Build
        run: pnpm --filter @dicee/web build

      - name: Deploy to Cloudflare Pages
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: packages/web
          command: pages deploy .svelte-kit/cloudflare --project-name=dicee --commit-dirty=true
