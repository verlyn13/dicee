# GitHub Copilot CLI MCP Configuration for Dicee

This configuration tailors GitHub Copilot CLI for **DevOps and error checking** workflows in the Dicee project.

## Setup Instructions

### 1. Copy Configuration to Copilot

```bash
# Backup existing config (if any)
cp ~/.copilot/mcp-config.json ~/.copilot/mcp-config.json.backup

# Merge Dicee DevOps servers into your existing config
# You'll need to manually merge since you have other projects
```

### 2. Manual Merge

Edit `~/.copilot/mcp-config.json` and add these servers:

```json
{
  "mcpServers": {
    "dicee-akg": {
      "type": "local",
      "command": "bun",
      "args": [
        "run",
        "./packages/web/src/tools/akg/mcp/server.ts"
      ],
      "env": {
        "AKG_GRAPH_PATH": "./docs/architecture/akg/graph/current.json",
        "AKG_DIAGRAMS_PATH": "./docs/architecture/akg/diagrams"
      },
      "description": "Dicee architecture queries - layer rules, import validation, invariant checks",
      "tools": ["*"]
    },
    "dicee-devops": {
      "type": "local",
      "command": "bash",
      "args": [
        "./scripts/copilot-mcp-wrapper.sh"
      ],
      "description": "Dicee DevOps - quality gates, deployment, error checking",
      "tools": ["*"]
    }
  }
}
```

**Important**: Only the `dicee-akg` server works as an MCP server. The `dicee-devops` is just a command wrapper.

### 3. Available Commands via Wrapper

From within the dicee project directory in Copilot CLI:

```bash
# Quality & Error Checking
./scripts/copilot-mcp-wrapper.sh quality-gate    # Full 7-check quality gate
./scripts/copilot-mcp-wrapper.sh check-errors    # Quick error scan
./scripts/copilot-mcp-wrapper.sh fix-errors      # Auto-fix lint issues
./scripts/copilot-mcp-wrapper.sh check-secrets   # Scan for leaked secrets
./scripts/copilot-mcp-wrapper.sh deploy-check    # Pre-deployment verification

# Deployment
./scripts/copilot-mcp-wrapper.sh deploy-do       # Deploy Durable Objects
./scripts/copilot-mcp-wrapper.sh deploy-pages    # Deploy Pages
./scripts/copilot-mcp-wrapper.sh deploy-full     # Full deployment
./scripts/copilot-mcp-wrapper.sh tail-logs       # Stream logs

# Environment
./scripts/copilot-mcp-wrapper.sh check-env       # Check credentials
./scripts/copilot-mcp-wrapper.sh status          # Project status
```

## AKG MCP Server Tools

When the `dicee-akg` server is active, you get these MCP tools:

| Tool | Purpose | Example Use |
|------|---------|-------------|
| `akg_layer_rules` | Get allowed/forbidden imports | "Can components import stores?" |
| `akg_node_info` | File metadata (type, layer, edges) | "What is this file?" |
| `akg_check_import` | Validate proposed import | Pre-flight before adding import |
| `akg_invariants` | Run architecture checks | Quality gate awareness |
| `akg_diagram` | Generate Mermaid diagrams | Visualize architecture |
| `akg_path_exists` | Find dependency paths | Impact analysis |
| `akg_cache_status` | Cache management | Reload after discovery |

## Typical DevOps Workflows

### Pre-Commit Error Check

```bash
# In Copilot CLI
"Check for errors before I commit"
# Copilot runs: ./scripts/copilot-mcp-wrapper.sh check-errors
```

### Pre-Deployment

```bash
"Run full quality gate and check if we can deploy"
# Copilot runs:
# 1. ./scripts/copilot-mcp-wrapper.sh quality-gate
# 2. ./scripts/copilot-mcp-wrapper.sh deploy-check
```

### Fix Linting Issues

```bash
"Fix all linting errors"
# Copilot runs: ./scripts/copilot-mcp-wrapper.sh fix-errors
```

### Deployment

```bash
"Deploy to production"
# Copilot runs: ./scripts/copilot-mcp-wrapper.sh deploy-full
# Which does: quality-gate → deploy-do → deploy-pages
```

### Architecture Validation

```bash
"Can I import authStore in this component?"
# Uses akg_check_import tool to validate
```

### Monitor Production

```bash
"Tail production logs"
# Copilot runs: ./scripts/copilot-mcp-wrapper.sh tail-logs
```

## Quality Gate Checks (7 total)

The quality gate runs these checks:

1. **TypeScript & Rust** - Type checking for all packages
2. **AKG Invariants** - 6 architectural invariant checks
3. **Biome Lint** - Code quality and style
4. **Test Suite** - All unit tests
5. **Secrets Scan** - Infisical leak detection
6. **Build** - Production build verification
7. **Diagram Staleness** - AKG diagrams are current

## Environment Prerequisites

Before using deployment commands, ensure:

```bash
# Load Cloudflare credentials
dicee-cf

# Load Infisical credentials
dicee-env dev  # or staging/prod

# Load Supabase MCP token (if using Supabase MCP)
export SUPABASE_MCP_TOKEN=$(gopass show -o dicee/supabase/mcp-token)
```

## Integration with Project Workflow

This config is designed for:

- **Error checking** before commits
- **Quality gates** before merging PRs
- **Deployment automation** with safety checks
- **Architecture validation** during development
- **Production monitoring** and debugging

It complements Claude Code CLI (primary development) by providing quick DevOps operations and deployment workflows.

## Troubleshooting

### AKG Server Won't Start

```bash
# Ensure graph exists
pnpm akg:discover

# Test server manually
pnpm akg:test
```

### Command Not Found

Make sure you're in the project root:

```bash
cd /Users/verlyn13/Development/personal/dicee
```

### Permission Denied

```bash
chmod +x ./scripts/copilot-mcp-wrapper.sh
```

### Wrangler Auth Failed

```bash
# Load Cloudflare credentials
dicee-cf

# Verify
wrangler whoami
```

## See Also

- `.claude/workflow-orchestration.md` - Full MCP workflow docs
- `.claude/AGENT-GUARDRAILS.md` - Agent rules and guardrails
- `scripts/quality-gate.sh` - Quality gate implementation
- `docs/architecture/akg/` - AKG documentation
