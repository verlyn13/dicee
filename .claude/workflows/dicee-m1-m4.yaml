# Dicee Engine M1-M4 Upgrade Workflow
# Machine-readable task specifications for agent-assignable work
# Reference: .claude/plans/quirky-wandering-harbor.md

workflow: dicee-m1-m4-upgrade
version: 1.0.0
created: 2025-12-05

metadata:
  description: "Upgrade Dicee engine from 662-line MVP to full 4-layer architecture"
  scope:
    - M1: 252 canonical configurations (Layer 0)
    - M2: Exact transition probabilities (Layer 1)
    - M3: Dynamic programming solver (Layer 2)
    - M4: Enhanced WASM API (Layer 3)
  strategy: "Additive-first migration with controlled deprecation"
  three_strikes_enforced: true
  ci_integration: required
  approval_gates:
    - phase_2_start
    - phase_5b_start
    - phase_8_cleanup
  total_estimated_days: 14.5
  source_archive: "/Users/verlyn13/00_inbox/dicee-engine-extracted/dicee-engine/"

# =============================================================================
# GOVERNANCE: ARCHITECTURE DECISION RECORDS
# =============================================================================

governance:
  adrs:
    - id: ADR-001
      name: "Canonical Configuration Model"
      path: "docs/rfcs/adr-001-config-model.md"
      status: Accepted
      version: "1.1"
      decision: "Adopt 252 unordered dice configurations (stars and bars formula)"
      rationale: "30.86x state space reduction (7776 → 252)"
      implemented_in: [DICEE-003, DICEE-004]

    - id: ADR-002
      name: "Transition Probability Strategy"
      path: "docs/rfcs/adr-002-transition-strategy.md"
      status: Accepted
      version: "1.1"
      decision: "Precompute full transition matrix with lazy initialization"
      rationale: "O(1) lookup vs O(n) computation, 16MB acceptable memory"
      implemented_in: [DICEE-006]

    - id: ADR-003
      name: "Solver Algorithm Selection"
      path: "docs/rfcs/adr-003-solver-algorithm.md"
      status: Accepted
      version: "1.0"
      decision: "Memoized backward induction dynamic programming"
      rationale: "Optimal for single-turn bounded state space (252 × 3 × 2^13)"
      implemented_in: [DICEE-009]

    - id: ADR-004
      name: "WASM API Versioning Policy"
      path: "docs/rfcs/adr-004-wasm-api-versioning.md"
      status: Accepted
      version: "1.1"
      decision: "Additive migration with controlled deprecation"
      rationale: "Clean API design, feature-flagged gradual adoption"
      implemented_in: [DICEE-012]

    - id: ADR-005
      name: "Property-Based Testing Requirements"
      path: "docs/rfcs/adr-005-property-testing.md"
      status: Planned
      blocks: DICEE-024
      decision: "Require proptest for all probabilistic components"
      rationale: "Mathematical correctness validation"

  completion_status:
    accepted: [ADR-001, ADR-002, ADR-003, ADR-004]
    planned: [ADR-005]
    last_updated: "2025-12-05"

  task_status:
    completed:
      - DICEE-001  # ADR-001 created
      - DICEE-002  # Cargo.toml updated
      - DICEE-003  # core/config.rs copied
      - DICEE-004  # core/error.rs, core/mod.rs copied
      - DICEE-005  # ADR-002 created
      - DICEE-006  # keep.rs + transition module copied
      - DICEE-007  # Scoring refactored to use DiceConfig
      - DICEE-008  # ADR-003 created
      - DICEE-009  # Solver module (turn.rs, solver.rs, category.rs) copied
      - DICEE-010  # Known position tests (16 tests)
      - DICEE-011  # ADR-004 created
      - DICEE-012  # WASM analyze_turn export added
    in_progress: []
    pending: [DICEE-013, DICEE-014, DICEE-015, DICEE-016, DICEE-017, DICEE-018, DICEE-019, DICEE-020, DICEE-021, DICEE-022, DICEE-023, DICEE-024, DICEE-025, DICEE-026, DICEE-027, DICEE-028]
    tests_passing: 110
    phase_completed: "5a"

# =============================================================================
# PHASE 0: GOVERNANCE SETUP (0.5 days)
# =============================================================================

tasks:
  - id: DICEE-001
    name: "Create ADR-001: Canonical Configuration Model"
    phase: 0
    agent_assignable: true
    complexity: low
    estimated_hours: 2
    inputs:
      - "/Users/verlyn13/00_inbox/files-11-extracted/development-plan.json"
      - "/Users/verlyn13/00_inbox/dicee-engine-extracted/dicee-engine/src/core/config.rs"
    outputs:
      - "docs/rfcs/adr-001-config-model.md"
    description: |
      Document the architectural decision to adopt 252 canonical configurations.
      Decision: Adopt 252 unordered dice configurations (stars and bars formula)
      Rationale: 30.86x state space reduction (7776 -> 252)
      Alternatives: Keep ordered dice, use hash table
    verification: "markdown lint passes, document exists with required sections"
    blocks:
      - DICEE-002

# =============================================================================
# PHASE 1: FOUNDATION - LAYER 0 (1 day)
# =============================================================================

  - id: DICEE-002
    name: "Update Cargo.toml dependencies"
    phase: 1
    agent_assignable: true
    complexity: low
    estimated_hours: 1
    depends_on:
      - DICEE-001
    inputs:
      - "packages/engine/Cargo.toml"
    outputs:
      - "packages/engine/Cargo.toml"
    description: |
      Add required dependencies for new architecture:
      - thiserror = "2.0"
      - num-rational = { version = "0.4", optional = true }
      - num-traits = { version = "0.2", optional = true }
      - proptest = { version = "1.5", optional = true }
      Add features: exact-rational, property-tests
    verification: "cargo check --all-features"
    three_strikes: true
    blocks:
      - DICEE-003
      - DICEE-004

  - id: DICEE-003
    name: "Copy core/config.rs"
    phase: 1
    agent_assignable: true
    complexity: medium
    estimated_hours: 2
    depends_on:
      - DICEE-002
    inputs:
      - "/Users/verlyn13/00_inbox/dicee-engine-extracted/dicee-engine/src/core/config.rs"
    outputs:
      - "packages/engine/src/core/config.rs"
    description: |
      Copy the foundational DiceConfig type and ConfigIndex.
      This is Layer 0 - ALL other layers depend on this.
      Contains: DiceConfig struct, ConfigIndex newtype, ALL_CONFIGS static array,
      multiplicity calculations, index bijection.
    verification: "cargo check && cargo test core::config"
    three_strikes: true
    blocks:
      - DICEE-005
      - DICEE-006

  - id: DICEE-004
    name: "Copy core/error.rs and core/mod.rs"
    phase: 1
    agent_assignable: true
    complexity: low
    estimated_hours: 1
    depends_on:
      - DICEE-002
    inputs:
      - "/Users/verlyn13/00_inbox/dicee-engine-extracted/dicee-engine/src/core/error.rs"
      - "/Users/verlyn13/00_inbox/dicee-engine-extracted/dicee-engine/src/core/mod.rs"
    outputs:
      - "packages/engine/src/core/error.rs"
      - "packages/engine/src/core/mod.rs"
    description: |
      Copy error types (DiceeError enum) and module re-exports.
      Update mod.rs to only include config initially, expand as phases progress.
    verification: "cargo check"
    three_strikes: true

# =============================================================================
# PHASE 2: TRANSITIONS - LAYER 1 (2 days)
# =============================================================================

  - id: DICEE-005
    name: "Create ADR-002: Transition Probability Strategy"
    phase: 2
    agent_assignable: true
    complexity: low
    estimated_hours: 2
    depends_on:
      - DICEE-003
    outputs:
      - "docs/rfcs/adr-002-transition-strategy.md"
    description: |
      Document the transition probability architecture decision.
      Decision: Precompute full transition matrix (16MB) with lazy initialization
      Rationale: O(1) lookup vs O(n) computation, acceptable memory footprint
      Alternatives: On-demand compute, LRU cache, sparse matrix
    verification: "markdown lint passes"
    blocks:
      - DICEE-006

  - id: DICEE-006
    name: "Copy keep.rs and transition module"
    phase: 2
    agent_assignable: true
    complexity: high
    estimated_hours: 6
    depends_on:
      - DICEE-003
      - DICEE-005
    inputs:
      - "/Users/verlyn13/00_inbox/dicee-engine-extracted/dicee-engine/src/core/keep.rs"
      - "/Users/verlyn13/00_inbox/dicee-engine-extracted/dicee-engine/src/transition/probability.rs"
      - "/Users/verlyn13/00_inbox/dicee-engine-extracted/dicee-engine/src/transition/table.rs"
      - "/Users/verlyn13/00_inbox/dicee-engine-extracted/dicee-engine/src/transition/mod.rs"
    outputs:
      - "packages/engine/src/core/keep.rs"
      - "packages/engine/src/transition/probability.rs"
      - "packages/engine/src/transition/table.rs"
      - "packages/engine/src/transition/mod.rs"
    description: |
      Copy KeepPattern and PartialDice types (keep.rs).
      Copy full transition probability module with:
      - probability.rs: Multinomial calculations, factorial lookup
      - table.rs: Lazy-static transition matrix (252x32x252)
      - mod.rs: Module exports
      Table generation takes ~10s in release mode.
    verification: "cargo test transition && cargo test --release transition::table::tests::test_table_initialization"
    three_strikes: true
    blocks:
      - DICEE-007
    approval_gate: phase_2_start

# =============================================================================
# PHASE 3: SCORING REFACTOR (1 day)
# =============================================================================

  - id: DICEE-007
    name: "Refactor scoring to use DiceConfig"
    phase: 3
    agent_assignable: true
    complexity: medium
    estimated_hours: 4
    depends_on:
      - DICEE-006
    inputs:
      - "packages/engine/src/scoring.rs"
      - "/Users/verlyn13/00_inbox/dicee-engine-extracted/dicee-engine/src/scoring/rules.rs"
    outputs:
      - "packages/engine/src/scoring/rules.rs"
      - "packages/engine/src/scoring/mod.rs"
    description: |
      Create scoring module that works with DiceConfig instead of ordered dice.
      - Create src/scoring/ directory
      - Adapt scoring logic to use config.counts() instead of dice array
      - Preserve all 8 existing scoring tests
      - Add adapter function for backward compatibility during migration
    verification: "cargo test scoring && all 8 original tests pass"
    three_strikes: true
    blocks:
      - DICEE-008

# =============================================================================
# PHASE 4: SOLVER - LAYER 2 (3 days)
# =============================================================================

  - id: DICEE-008
    name: "Create ADR-003: Solver Algorithm"
    phase: 4
    agent_assignable: true
    complexity: low
    estimated_hours: 2
    depends_on:
      - DICEE-007
    outputs:
      - "docs/rfcs/adr-003-solver-algorithm.md"
    description: |
      Document the solver algorithm decision.
      Decision: Backward induction dynamic programming with memoization
      Rationale: Optimal for single-turn bounded state space (252 x 3 x 2^13)
      Alternatives: Monte Carlo sampling, greedy heuristics
    verification: "markdown lint passes"
    blocks:
      - DICEE-009

  - id: DICEE-009
    name: "Copy solver module (turn.rs, solver.rs, category.rs)"
    phase: 4
    agent_assignable: true
    complexity: high
    estimated_hours: 8
    depends_on:
      - DICEE-008
    inputs:
      - "/Users/verlyn13/00_inbox/dicee-engine-extracted/dicee-engine/src/core/turn.rs"
      - "/Users/verlyn13/00_inbox/dicee-engine-extracted/dicee-engine/src/core/solver.rs"
      - "/Users/verlyn13/00_inbox/dicee-engine-extracted/dicee-engine/src/core/category.rs"
    outputs:
      - "packages/engine/src/core/turn.rs"
      - "packages/engine/src/core/solver.rs"
      - "packages/engine/src/core/category.rs"
    description: |
      Copy the dynamic programming solver:
      - turn.rs: TurnState, Action enum, TurnAnalysis result type
      - solver.rs: TurnSolver with memoization cache, Bellman equation
      - category.rs: Enhanced Category enum, CategorySet bitmask
      Update core/mod.rs with new re-exports.
    verification: "cargo test core::solver && cargo bench solver"
    three_strikes: true
    blocks:
      - DICEE-010

  - id: DICEE-010
    name: "Add known position tests"
    phase: 4
    agent_assignable: true
    complexity: medium
    estimated_hours: 4
    depends_on:
      - DICEE-009
    outputs:
      - "packages/engine/tests/known_positions.rs"
    description: |
      Create integration test file with 15 known positions from Yahtzee literature.
      Test cases:
      - Yahtzee detection and scoring
      - Straight detection (small/large)
      - Full house variations
      - Three/four of a kind
      - Upper section optimization
      Each position must match published optimal strategy.
    verification: "cargo test known_positions && 100% pass rate"
    three_strikes: true

  - id: DICEE-011
    name: "Create ADR-004: WASM API Versioning"
    phase: 4
    agent_assignable: true
    complexity: low
    estimated_hours: 2
    depends_on:
      - DICEE-010
    outputs:
      - "docs/rfcs/adr-004-wasm-api-versioning.md"
    description: |
      Document WASM API versioning and migration strategy.
      Decision: Breaking change with additive migration path
      Rationale: Clean API design, feature-flagged gradual adoption
      Alternatives: Maintain compatibility, dual APIs forever
      Include: Migration timeline, deprecation schedule
    verification: "markdown lint passes"
    approval_gate: phase_5b_start
    blocks:
      - DICEE-012

# =============================================================================
# PHASE 5A: WASM EXPORTS - ADDITIVE (0.5 days)
# =============================================================================

  - id: DICEE-012
    name: "Phase 5a: Add new WASM exports (additive only)"
    phase: 5a
    agent_assignable: true
    complexity: high
    estimated_hours: 4
    depends_on:
      - DICEE-011
    outputs:
      - "packages/engine/src/wasm/mod.rs"
    description: |
      Create new WASM module with solver API.
      CRITICAL: NO DELETIONS - old API remains functional.
      New exports:
      - analyze_turn(dice, rolls_remaining, available_categories_bitmask) -> TurnAnalysis
      - score_category_v2(dice, category) -> enhanced result
      - score_all_categories_v2(dice) -> enhanced result
      Keep existing: calculate_probabilities, score_category, score_all_categories
    verification: "cargo build --target wasm32-unknown-unknown && wasm-pack build succeeds"
    three_strikes: true
    blocks:
      - DICEE-013

# =============================================================================
# PHASE 5B: FEATURE-FLAGGED FRONTEND (1 day)
# =============================================================================

  - id: DICEE-013
    name: "Phase 5b: Frontend feature-flagged migration"
    phase: 5b
    agent_assignable: true
    complexity: high
    estimated_hours: 8
    depends_on:
      - DICEE-012
    inputs:
      - "packages/web/src/lib/engine.ts"
    outputs:
      - "packages/web/src/lib/engine.ts"
      - "packages/web/src/lib/types.ts"
      - "packages/web/.env"
    description: |
      Add feature flag for gradual frontend migration.
      - Add VITE_ENABLE_NEW_ENGINE=false to .env
      - Update engine.ts with USE_NEW_API conditional
      - Add TurnAnalysis and KeepRecommendation type definitions
      - Implement dual-mode: old API (default) vs new API (flag enabled)
    verification: "pnpm test && pnpm build && feature flag ENABLE_NEW_ENGINE=true works"
    three_strikes: true
    approval_gate: true
    blocks:
      - DICEE-014

# =============================================================================
# PHASE 5C: FRONTEND INTEGRATION (1 day)
# =============================================================================

  - id: DICEE-014
    name: "Phase 5c: Update all frontend integration points"
    phase: 5c
    agent_assignable: true
    complexity: very_high
    estimated_hours: 8
    depends_on:
      - DICEE-013
    inputs:
      - "packages/web/src/lib/stores/game.svelte.ts"
      - "packages/web/src/routes/dicee/+page.svelte"
    outputs:
      - "15 critical frontend files updated"
    description: |
      Comprehensive frontend migration to new solver API.
      Files to update (see subtasks DICEE-016 through DICEE-021):
      - TypeScript bridge (engine.ts)
      - Service layer (services/engine.ts)
      - Game state store (game.svelte.ts)
      - Type definitions (types.ts)
      - Game route (+page.svelte)
      - All test mocks (5 files)
    verification: "pnpm test && all integration tests pass"
    three_strikes: true
    blocks:
      - DICEE-015

# =============================================================================
# PHASE 5D: DEPRECATION (0.5 days)
# =============================================================================

  - id: DICEE-015
    name: "Phase 5d: Deprecate old WASM exports"
    phase: 5d
    agent_assignable: true
    complexity: low
    estimated_hours: 2
    depends_on:
      - DICEE-014
    outputs:
      - "packages/engine/src/wasm/mod.rs with deprecation warnings"
    description: |
      Mark old WASM exports as deprecated.
      - Add #[deprecated(since = "0.2.0", note = "Use analyze_turn instead")]
      - Add console::warn() calls in old functions
      - Update README with migration guide
      - Set removal timeline: 6 weeks post-deprecation (Phase 8)
      Functions still work, but emit warnings.
    verification: "cargo build && deprecation warnings shown"
    blocks:
      - DICEE-022

# =============================================================================
# FRONTEND SUBTASKS (Detail breakdown of DICEE-014)
# =============================================================================

  - id: DICEE-016
    name: "TypeScript Bridge Updates"
    phase: 5c
    parent_task: DICEE-014
    agent_assignable: true
    complexity: high
    estimated_hours: 5
    inputs:
      - "packages/web/src/lib/engine.ts"
    outputs:
      - "packages/web/src/lib/engine.ts"
    description: |
      Update TypeScript WASM bridge with new API.
      - Add analyzeTurn() function with proper FFI types
      - Add categoriesToBitmask() helper
      - Add type definitions: TurnAnalysis, KeepRecommendation
      - Input validation: dice range [1,6], rolls [0,2]
      - Error mapping from WASM to TypeScript
    verification: "TypeScript compiles, unit tests pass"
    three_strikes: true

  - id: DICEE-017
    name: "Service Layer Updates"
    phase: 5c
    parent_task: DICEE-014
    agent_assignable: true
    complexity: medium
    estimated_hours: 4
    depends_on:
      - DICEE-016
    inputs:
      - "packages/web/src/lib/services/engine.ts"
    outputs:
      - "packages/web/src/lib/services/engine.ts"
    description: |
      Update service layer with new API integration.
      - Add analyzeTurnOptimal() method
      - Implement fallback logic for old API
      - Feature flag integration (USE_NEW_SOLVER)
      - Add telemetry: API usage tracking, latency metrics
      - Concurrent request deduplication preserved
    verification: "Service tests pass, both API modes work"

  - id: DICEE-018
    name: "Game State Store Updates"
    phase: 5c
    parent_task: DICEE-014
    agent_assignable: true
    complexity: very_high
    estimated_hours: 7
    depends_on:
      - DICEE-017
    inputs:
      - "packages/web/src/lib/stores/game.svelte.ts"
    outputs:
      - "packages/web/src/lib/stores/game.svelte.ts"
    description: |
      Major update to game state management (Svelte 5 runes).
      New state:
      - #currentAnalysis = $state<TurnAnalysis | null>(null)
      - #analysisLoading = $state<boolean>(false)
      - #analysisError = $state<Error | null>(null)
      New derived: showKeepRecommendation, recommendationText
      New methods: applyKeepRecommendation(), autoScoreIfRecommended()
      Integration: Call analyzeTurnOptimal() after each roll
      Handle: Race conditions, stale state prevention
    verification: "State tests pass, integration tests pass"
    three_strikes: true

  - id: DICEE-019
    name: "Type Definitions Centralization"
    phase: 5c
    parent_task: DICEE-014
    agent_assignable: true
    complexity: low
    estimated_hours: 2
    outputs:
      - "packages/web/src/lib/types.ts"
    description: |
      Centralize new type definitions.
      - Move TurnAnalysis, KeepRecommendation from engine.ts
      - Add CategoryProbability interface with expectedValue field
      - Add Action union type ('stop' | 'continue')
      - Add JSDoc documentation for all types
      - Export for use across components
    verification: "TypeScript compiles, types importable"

  - id: DICEE-020
    name: "Main Game Route UI"
    phase: 5c
    parent_task: DICEE-014
    agent_assignable: true
    complexity: medium
    estimated_hours: 4
    depends_on:
      - DICEE-018
    inputs:
      - "packages/web/src/routes/dicee/+page.svelte"
    outputs:
      - "packages/web/src/routes/dicee/+page.svelte"
    description: |
      Update game UI with recommendation display.
      - Add recommendation panel (conditional on showKeepRecommendation)
      - Visual dice highlighting for keep suggestions
      - Show expected value for recommended action
      - Loading state indicator during analysis
      - Button: "Use Recommendation (EV: X.X)"
    verification: "Visual tests pass, accessibility checks pass"

  - id: DICEE-021
    name: "Test Mocks and Integration Tests"
    phase: 5c
    parent_task: DICEE-014
    agent_assignable: true
    complexity: medium
    estimated_hours: 5
    inputs:
      - "packages/web/src/lib/services/__mocks__/engine-module.ts"
      - "packages/web/src/lib/services/__mocks__/dicee-engine.ts"
    outputs:
      - "packages/web/src/lib/services/__mocks__/engine-module.ts"
      - "packages/web/src/lib/services/__mocks__/dicee-engine.ts"
      - "packages/web/src/lib/services/analyzeTurn.test.ts"
    description: |
      Update test infrastructure for new API.
      - Mock analyze_turn WASM function with realistic responses
      - Add integration tests for analyzeTurnOptimal
      - Test cases: Yahtzee detection, keep recommendations, fallback path
      - Mock both success and failure scenarios
      - Performance: Mock responses < 1ms
    verification: "All mocked tests pass, integration tests pass"
    three_strikes: true

# =============================================================================
# PHASE 6: TESTING & REFINEMENT (2 days)
# =============================================================================

  - id: DICEE-022
    name: "Regenerate WASM bindings"
    phase: 6
    agent_assignable: true
    complexity: medium
    estimated_hours: 3
    depends_on:
      - DICEE-015
    outputs:
      - "packages/web/src/lib/wasm/"
    description: |
      Regenerate TypeScript WASM bindings.
      Command: wasm-pack build --target web --out-dir ../web/src/lib/wasm
      Verify: New types available, old types still present
      Test: Import and use in browser
    verification: "wasm-pack build succeeds, TypeScript imports work"

  - id: DICEE-023
    name: "Create ADR-005: Property-Based Testing"
    phase: 6
    agent_assignable: true
    complexity: low
    estimated_hours: 2
    outputs:
      - "docs/rfcs/adr-005-property-testing.md"
    description: |
      Document property-based testing requirements.
      Decision: Require proptest for all probabilistic components
      Rationale: Mathematical correctness validation
      Properties: Sum P = 1.0, EV bounds, bijection
    verification: "markdown lint passes"

  - id: DICEE-024
    name: "Add property-based tests"
    phase: 6
    agent_assignable: true
    complexity: medium
    estimated_hours: 4
    depends_on:
      - DICEE-023
    outputs:
      - "packages/engine/tests/proptests.rs"
    description: |
      Implement property-based tests using proptest.
      Properties:
      - prop_config_roundtrip: Index <-> Config bijection
      - prop_transition_sum_to_one: All transitions sum to 1.0
      - prop_solver_ev_bounded: 0.0 <= EV <= 50.0
      - prop_multiplicity_sum: Sum = 7776
    verification: "cargo test --features property-tests"

  - id: DICEE-025
    name: "Performance benchmarks"
    phase: 6
    agent_assignable: true
    complexity: medium
    estimated_hours: 3
    outputs:
      - "packages/engine/benches/solver.rs"
    description: |
      Add comprehensive performance benchmarks.
      Targets:
      - Config operations: < 100ns
      - Transition lookup: < 1us
      - Solver typical: < 10ms
      - Full analysis: < 20ms
    verification: "cargo bench, all targets met"

# =============================================================================
# PHASE 7: CI/CD INTEGRATION (1 day)
# =============================================================================

  - id: DICEE-026
    name: "Update CI pipeline"
    phase: 7
    agent_assignable: true
    complexity: medium
    estimated_hours: 4
    outputs:
      - ".github/workflows/ci.yml"
    description: |
      Update GitHub Actions CI pipeline.
      Add jobs:
      - Property tests (--features property-tests)
      - Exact rational tests (--features exact-rational)
      - Known position validation
      - WASM size gate (< 150KB)
      - Benchmark regression gate (P95 < 30ms)
      - Frontend dual-mode tests (old + new API)
    verification: "CI pipeline passes on PR"

  - id: DICEE-027
    name: "Update pre-commit hooks"
    phase: 7
    agent_assignable: true
    complexity: low
    estimated_hours: 2
    outputs:
      - ".lefthook.yml"
    description: |
      Update Lefthook pre-commit configuration.
      Add hooks:
      - rust-config-test: Quick smoke test for config layer
      - rust-property-tests: Run before push
      Preserve existing: rust-fmt, rust-lint
    verification: "lefthook run pre-commit succeeds"

# =============================================================================
# PHASE 8: CLEANUP & REMOVAL (1 day)
# =============================================================================

  - id: DICEE-028
    name: "Phase 8: Delete deprecated code"
    phase: 8
    agent_assignable: true
    complexity: medium
    estimated_hours: 4
    depends_on:
      - DICEE-026
      - DICEE-027
    description: |
      Remove all deprecated code paths.
      Delete:
      - Old WASM exports (calculate_probabilities, etc.)
      - packages/engine/src/types.rs
      - packages/engine/src/probability.rs
      Cleanup:
      - cargo fmt
      - cargo clippy
      - pnpm lint
    verification: "cargo build && pnpm build && all tests pass"
    approval_gate: phase_8_cleanup

# =============================================================================
# THREE STRIKES ENFORCEMENT POINTS
# =============================================================================

three_strikes_tasks:
  - DICEE-002  # Dependency resolution
  - DICEE-003  # Core foundation
  - DICEE-006  # Performance layer
  - DICEE-007  # Regression risk
  - DICEE-009  # Complex logic
  - DICEE-012  # Cross-compilation
  - DICEE-013  # Frontend API
  - DICEE-014  # Integration risk
  - DICEE-016  # FFI boundary
  - DICEE-018  # State management
  - DICEE-021  # Test infrastructure

escalation_protocol:
  after_3_failures: STOP immediately
  report:
    - what_attempted: "Describe 3 approaches tried"
    - why_failed: "Error messages, root cause analysis"
    - results_observed: "Logs, outputs, behavior"
  wait_for: "Human review and guidance before continuing"
  never: "Do NOT try alternative approaches past 3 failures"

# =============================================================================
# TIMELINE
# =============================================================================

timeline:
  - phase: 0
    name: "Governance Setup"
    duration_days: 0.5
    tasks: [DICEE-001]
    cumulative_days: 0.5

  - phase: 1
    name: "Foundation (Layer 0)"
    duration_days: 1
    tasks: [DICEE-002, DICEE-003, DICEE-004]
    cumulative_days: 1.5

  - phase: 2
    name: "Transitions (Layer 1)"
    duration_days: 2
    tasks: [DICEE-005, DICEE-006]
    cumulative_days: 3.5

  - phase: 3
    name: "Scoring Refactor"
    duration_days: 1
    tasks: [DICEE-007]
    cumulative_days: 4.5

  - phase: 4
    name: "Solver (Layer 2)"
    duration_days: 3
    tasks: [DICEE-008, DICEE-009, DICEE-010, DICEE-011]
    cumulative_days: 7.5

  - phase: 5a
    name: "Add WASM Exports"
    duration_days: 0.5
    tasks: [DICEE-012]
    cumulative_days: 8

  - phase: 5b
    name: "Feature-Flagged Frontend"
    duration_days: 1
    tasks: [DICEE-013]
    cumulative_days: 9

  - phase: 5c
    name: "Migrate Integration Points"
    duration_days: 1
    tasks: [DICEE-014, DICEE-016, DICEE-017, DICEE-018, DICEE-019, DICEE-020, DICEE-021]
    cumulative_days: 10

  - phase: 5d
    name: "Deprecate Old API"
    duration_days: 0.5
    tasks: [DICEE-015]
    cumulative_days: 10.5

  - phase: 6
    name: "Testing & Refinement"
    duration_days: 2
    tasks: [DICEE-022, DICEE-023, DICEE-024, DICEE-025]
    cumulative_days: 12.5

  - phase: 7
    name: "CI/CD Integration"
    duration_days: 1
    tasks: [DICEE-026, DICEE-027]
    cumulative_days: 13.5

  - phase: 8
    name: "Cleanup & Removal"
    duration_days: 1
    tasks: [DICEE-028]
    cumulative_days: 14.5

# =============================================================================
# SUCCESS CRITERIA
# =============================================================================

success_criteria:
  technical:
    - "252 canonical configurations correctly enumerated"
    - "Transition probabilities sum to 1.0 (within 1e-9)"
    - "Solver produces optimal recommendations for all test positions"
    - "P95 latency < 20ms (Rust) or < 30ms (browser with network)"
    - "WASM binary < 150KB uncompressed"
    - "Property tests validate mathematical correctness"
    - "Both old and new APIs pass all tests (Phase 5b-5c)"

  quality:
    - "100% of existing tests pass"
    - "Property tests validate correctness"
    - "No Clippy warnings, no Biome warnings"
    - "Documentation complete (rustdoc + TypeScript)"
    - "CI pipeline includes all new test types"

  integration:
    - "Frontend displays keep recommendations"
    - "Game flow unchanged from user perspective"
    - "No breaking changes for saved games (until deprecation ends)"
    - "Performance monitoring shows stable latency"
    - "Feature flag enables gradual rollout"

  governance:
    - "All 5 ADRs created and approved"
    - "Workflow tasks tracked in this file"
    - "Three Strikes Rule enforced at critical points"
    - "Human approval gates passed (Phase 2, 5b, 8)"
